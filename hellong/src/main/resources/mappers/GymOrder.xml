<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oracle.hellong.GymOrderMapper">

	<!-- 포인트 사용 -->
	<select id="hsTotalListGymOrderDealCnt" resultType="int">
		SELECT count(*)
		FROM gym_order 
		WHERE m_number = #{m_number}
			AND refund_date IS NULL
	</select>
	
	<select id="hsListGymOrderDeal" parameterType="Member" resultType="GymOrder">
		SELECT *
		FROM
			(SELECT rownum rn, (a.g_name || ' ' || a.gs_s_detail || ' 구매') "pl_content",
					a.deal_date "pl_date", ('-' || a.use_point) "pl_point"
			 FROM
			     (SELECT g.g_name, gs.s_detail gs_s_detail, go.*
			      FROM gym g, g_s gs, gym_order go
			      WHERE g.g_id = gs.g_id
				   	  AND gs.g_id = go.g_id
				   	  AND gs.s_number = go.s_number
				   	  AND go.m_number = #{m_number}
				   	  AND go.refund_date IS NULL
			      ORDER BY go.refund_date DESC
			    ) a
			)
	WHERE  rn BETWEEN #{start} and #{end} 
	
	</select>
	
	<!-- 포인트 환불  -->
	<select id="hsTotalListGymOrderRefundCnt" parameterType="int" resultType="int">
		SELECT count(*)
		FROM gym_order
		WHERE m_number = #{m_number}
			AND refund_date IS NOT NULL
	</select>
	
	<select id="hsListGymOrderRefund" parameterType="Member" resultType="GymOrder">
		SELECT *
		FROM
			(SELECT rownum rn, (a.g_name || ' ' || a.gs_s_detail || ' 환불') "pl_content",
					a.refund_date "pl_date", ('+' || a.refund_point) "pl_point"
			 FROM
			     (SELECT g.g_name, gs.s_detail gs_s_detail, go.*
			      FROM gym g, g_s gs, gym_order go
			      WHERE g.g_id = gs.g_id
				   	  AND gs.g_id = go.g_id
				   	  AND gs.s_number = go.s_number
				   	  AND go.m_number = #{m_number}
				   	  AND go.refund_date IS NOT NULL
			      ORDER BY go.refund_date DESC
			    ) a
			)
		WHERE  rn BETWEEN #{start} and #{end}
	</select>
	
	<!-- 헬스장 이용내역 조회 -->
	
	<select id="hsTotalUsingGym" parameterType="int" resultType="int">
		SELECT count(*)
		FROM gym_order
		WHERE m_number = #{m_number}
	</select>
	
	<select id="hsListUsingGym" parameterType="Member" resultType="GymOrder">
		SELECT
	</select>
	
	
	
	<!-- 헬스장 환불 -->
	
	<select id="hsListGymName" parameterType="int" resultType="GymOrder">
		SELECT DISTINCT g.g_name, g.g_id
		FROM gym g, gym_order go
		WHERE g.g_id = go.g_id
			AND go.m_number = #{m_number}
	</select>
	
	<select id="hsListGymSerivce" parameterType="map" resultType="GymOrder">
		SELECT go.*, (gs.s_name || ' - ' || gsd.s_detail) "rl_s_name"
		FROM g_s gs, g_s_detail gsd, gym_order go
		WHERE gs.g_id = gsd.g_id
			AND gs.g_id = go.g_id
			AND go.g_id = #{g_id}
			AND gs.s_number = gsd.s_number
			AND gsd.s_number = go.s_number
			AND gsd.s_detail = go.s_detail
			AND go.m_number = #{m_number}
	</select>
	
	<!-- case when 문법이 mybatis에서는 적용이안되서 function으로 값을 받아 수행
		case when이 되는 경우도 있는데 이 경우에는 작동이 되지 않았음 -->
   <select id="hsRefundPrice" parameterType="map" resultType="GymOrder">
    
      SELECT ROUND(a.use_point*(a.refund_criteria/100), -1) "refund_point", 
      		(a.refund_criteria || '% 환불') "refund_criteria"

      FROM	
         ( SELECT go.use_point,
         		  get_refund_criteria(#{g_id}, #{s_number}, #{s_detail}, #{m_number}) refund_criteria
           FROM gym_order go
           WHERE go.s_number = #{s_number}
           	AND go.s_detail = #{s_detail}
	     	AND go.g_id = #{g_id}
	     	AND go.m_number = #{m_number}
         )  a
    </select>

</mapper>